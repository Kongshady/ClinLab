# Reports Module - Implementation Guide

## Overview
The Reports Module provides comprehensive audit and compliance reporting for the Clinical Laboratory Management System, supporting ISO 15189 and regulatory requirements.

## 1. Report Categories Implemented

### 1.1 Equipment Maintenance Reports
**Purpose**: Track maintenance history, upcoming maintenance, and completion rates

**Database Tables**:
- `maintenance_history` (main table - may need to be created)
- `equipment` (equipment details)
- `section` (department/section info)
- `employee` (who performed maintenance)

**Fields Included**:
- Equipment name, model, serial number
- Section assignment
- Maintenance date
- Performed by (technician/engineer)
- Findings
- Action taken
- Status (completed/pending/overdue)
- Next due date

**Query Pattern**:
```php
DB::table('maintenance_history as mh')
    ->join('equipment as e', 'mh.equipment_id', '=', 'e.equipment_id')
    ->leftJoin('section as s', 'e.section_id', '=', 's.section_id')
    ->leftJoin('employee as emp', 'mh.performed_by', '=', 'emp.employee_id')
    ->select(
        'e.name as equipment_name',
        'e.model',
        'e.serial_no',
        's.label as section',
        DB::raw("CONCAT(emp.firstname, ' ', emp.lastname) as performed_by"),
        'mh.maintenance_date',
        'mh.findings',
        'mh.action_taken',
        'mh.status',
        'mh.next_due_date'
    )
    ->whereBetween('mh.maintenance_date', [$dateFrom, $dateTo])
    ->orderBy('mh.maintenance_date', 'desc')
    ->get();
```

### 1.2 Calibration & Testing Procedure Reports
**Purpose**: Monitor calibration schedules, results, and compliance

**Database Tables**:
- `calibration_record`
- `calibration_procedure`
- `equipment`
- `section`
- `employee`

**Fields Included**:
- Equipment name, model, serial
- Procedure name
- Calibration date
- Due date / Next calibration date
- Result status (pass/fail/conditional)
- Performed by
- Remarks/notes

**Query Pattern**:
```php
DB::table('calibration_record as cr')
    ->join('equipment as e', 'cr.equipment_id', '=', 'e.equipment_id')
    ->leftJoin('calibration_procedure as cp', 'cr.procedure_id', '=', 'cp.procedure_id')
    ->leftJoin('employee as emp', 'cr.performed_by', '=', 'emp.employee_id')
    ->select(
        'e.name as equipment_name',
        'cp.procedure_name',
        'cr.calibration_date',
        'cr.next_calibration_date as due_date',
        'cr.result_status',
        DB::raw("CONCAT(emp.firstname, ' ', emp.lastname) as performed_by"),
        'cr.notes as remarks'
    )
    ->whereBetween('cr.calibration_date', [$dateFrom, $dateTo])
    ->get();
```

### 1.3 Inventory & Supplies Reports
**Purpose**: Track stock movements, identify low stock, analyze usage patterns

**Database Tables**:
- `stock_in` (receiving)
- `stock_out` (issuing)
- `stock_usage` (consumption)
- `item`
- `section`
- `employee`

**Fields Included**:
- Item name
- Section
- Unit of measure
- Quantity IN
- Quantity OUT
- Transaction type (Stock In/Stock Out/Usage)
- Performed by
- Purpose
- Reference/OR number
- Transaction date

**Query Pattern** (UNION approach):
```php
$stockIn = DB::table('stock_in as si')
    ->join('item as i', 'si.item_id', '=', 'i.item_id')
    ->select(
        'i.label as item_name',
        'si.quantity as qty_in',
        DB::raw("0 as qty_out"),
        DB::raw("'Stock In' as transaction_type"),
        'si.datetime_added as transaction_date'
    );

$stockOut = DB::table('stock_out as so')
    ->join('item as i', 'so.item_id', '=', 'i.item_id')
    ->select(
        'i.label as item_name',
        DB::raw("0 as qty_in"),
        'so.quantity as qty_out',
        DB::raw("'Stock Out' as transaction_type"),
        'so.datetime_added as transaction_date'
    );

$stockUsage = DB::table('stock_usage as su')
    ->join('item as i', 'su.item_id', '=', 'i.item_id')
    ->select(
        'i.label as item_name',
        DB::raw("0 as qty_in"),
        'su.quantity as qty_out',
        DB::raw("'Usage' as transaction_type"),
        'su.datetime_used as transaction_date'
    );

$results = $stockIn->union($stockOut)->union($stockUsage)
    ->orderBy('transaction_date', 'desc')
    ->get();
```

### 1.4 Certificates Reports
**Purpose**: Track issued certificates, validity, revocations

**Database Tables**:
- `certificate_issues`
- `certificate_templates`
- `users`
- `equipment` (for linked records)

**Fields Included**:
- Certificate number
- Type
- Template version
- Issued at
- Valid until
- Generated by
- Status (Issued/Revoked/Expired)
- Linked record (equipment/calibration)

**Query Pattern**:
```php
DB::table('certificate_issues as ci')
    ->leftJoin('certificate_templates as ct', 'ci.template_id', '=', 'ct.id')
    ->leftJoin('users as u', 'ci.generated_by', '=', 'u.id')
    ->select(
        'ci.certificate_no',
        'ct.name as type',
        'ci.issued_at',
        'ci.valid_until',
        'u.name as generated_by',
        'ci.status'
    )
    ->whereBetween('ci.issued_at', [$dateFrom, $dateTo])
    ->get();
```

### 1.5 Laboratory Operations Reports
**Purpose**: Transaction summaries, test volumes

**Database Tables**:
- `transaction`
- `patient`

**Fields Included**:
- OR number
- Client/patient name
- Transaction date
- Daily transaction count

**Query Pattern**:
```php
DB::table('transaction as t')
    ->leftJoin('patient as p', 't.client_id', '=', 'p.patient_id')
    ->select(
        't.or_number',
        DB::raw("CONCAT(p.firstname, ' ', p.lastname) as client_name"),
        't.datetime_added as transaction_date'
    )
    ->whereBetween('t.datetime_added', [$dateFrom, $dateTo])
    ->get();
```

### 1.6 Activity Logs Report
**Purpose**: Audit trail of system actions

**Database Tables**:
- `activity_log`
- `employee`
- `users`

**Fields Included**:
- User name
- Action description
- Timestamp

**Query Pattern**:
```php
DB::table('activity_log as al')
    ->leftJoin('employee as e', 'al.employee_id', '=', 'e.employee_id')
    ->leftJoin('users as u', 'e.user_id', '=', 'u.id')
    ->select(
        DB::raw("COALESCE(u.name, CONCAT(e.firstname, ' ', e.lastname)) as user"),
        'al.description as action',
        'al.datetime_added as timestamp'
    )
    ->whereBetween('al.datetime_added', [$dateFrom, $dateTo])
    ->get();
```

## 2. Filter System

### Common Filters (All Reports)
- **Date Range**: dateFrom - dateTo (required)
- **Search**: General text search across relevant fields
- **Rows per page**: 10/25/50/100/All

### Report-Specific Filters
- **Maintenance/Calibration**: Section, Equipment, Status
- **Inventory**: Section, Item
- **Certificates**: Status (Issued/Revoked/Expired)
- **Activity Logs**: Employee

## 3. Export Functionality

### PDF Export
**Implementation Approach**:
1. Install DomPDF: `composer require barryvdh/laravel-dompdf`
2. Create export route in `web.php`:

```php
Route::middleware(['auth', 'permission:reports.export'])->group(function () {
    Route::get('/reports/export/pdf', [ReportsController::class, 'exportPdf'])->name('reports.export.pdf');
    Route::get('/reports/export/csv', [ReportsController::class, 'exportCsv'])->name('reports.export.csv');
});
```

3. Add export methods to `ReportsController`:

```php
use Barryvdh\DomPDF\Facade\Pdf;

public function exportPdf(Request $request)
{
    $type = $request->get('type');
    $dateFrom = $request->get('dateFrom');
    $dateTo = $request->get('dateTo');
    $filters = json_decode($request->get('filters'), true);
    
    // Get data based on report type
    $data = $this->getReportData($type, $dateFrom, $dateTo, $filters);
    
    $pdf = Pdf::loadView('reports.pdf.' . $type, [
        'data' => $data,
        'dateFrom' => $dateFrom,
        'dateTo' => $dateTo,
        'generatedAt' => now()
    ]);
    
    return $pdf->download($type . '-report-' . date('Y-m-d') . '.pdf');
}
```

### CSV Export
```php
public function exportCsv(Request $request)
{
    $type = $request->get('type');
    $dateFrom = $request->get('dateFrom');
    $dateTo = $request->get('dateTo');
    $filters = json_decode($request->get('filters'), true);
    
    $data = $this->getReportData($type, $dateFrom, $dateTo, $filters);
    
    $filename = $type . '-report-' . date('Y-m-d') . '.csv';
    
    $headers = [
        'Content-Type' => 'text/csv',
        'Content-Disposition' => 'attachment; filename="' . $filename . '"',
    ];
    
    $callback = function() use ($data, $type) {
        $file = fopen('php://output', 'w');
        
        // Write headers based on report type
        fputcsv($file, $this->getCsvHeaders($type));
        
        // Write data
        foreach ($data as $row) {
            fputcsv($file, (array)$row);
        }
        
        fclose($file);
    };
    
    return response()->stream($callback, 200, $headers);
}
```

## 4. Access Control (RBAC)

### Permissions Required
Add to your permission seeder:

```php
// In database/seeders/PermissionSeeder.php
$permissions = [
    'reports.access',
    'reports.export',
    'reports.maintenance',
    'reports.calibration',
    'reports.inventory',
    'reports.certificates',
    'reports.operations',
    'activity-logs.access',
];

foreach ($permissions as $permission) {
    Permission::create(['name' => $permission]);
}
```

### Route Protection
```php
Route::middleware(['auth', 'permission:reports.access'])->group(function () {
    Route::get('/reports', [ReportsController::class, 'index'])->name('reports.index');
});
```

### Component-Level Protection
In the Livewire component, check permissions before showing tabs:

```php
@can('reports.maintenance')
    <button wire:click="switchReport('maintenance')">Maintenance</button>
@endcan
```

## 5. UI Layout Structure

```
┌─────────────────────────────────────────────────────────┐
│  Reports & Analytics                                    │
│  Generate compliance and audit reports                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ [Maintenance] [Calibration] [Inventory] [Certificates]  │
│ [Operations] [Activity Logs]                            │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Filters                                                 │
│  Date From: [______] Date To: [______]                  │
│  Section: [Dropdown] Equipment: [Dropdown]              │
│  Search: [__________] Rows/page: [25▼]                  │
│                                                          │
│  [Reset Filters] [Export PDF] [Export CSV]              │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Report Results Table                                    │
│ ┌───────┬─────────┬──────────┬──────────┬──────────┐   │
│ │Column │ Column  │  Column  │  Column  │  Column  │   │
│ ├───────┼─────────┼──────────┼──────────┼──────────┤   │
│ │ Data  │  Data   │   Data   │   Data   │   Data   │   │
│ └───────┴─────────┴──────────┴──────────┴──────────┘   │
│                                                          │
│ [Pagination Controls]                                   │
└─────────────────────────────────────────────────────────┘
```

## 6. Files Created

### Controllers
- `app/Http/Controllers/ReportsController.php`

### Views
- `resources/views/reports/index.blade.php`
- `resources/views/components/reports/⚡index.blade.php` (main Livewire component)
- `resources/views/components/reports/tables/maintenance.blade.php`
- `resources/views/components/reports/tables/calibration.blade.php`
- `resources/views/components/reports/tables/inventory.blade.php`
- `resources/views/components/reports/tables/certificates.blade.php`
- `resources/views/components/reports/tables/operations.blade.php`
- `resources/views/components/reports/tables/activity-logs.blade.php`

### Routes
Already configured in `routes/web.php` (line ~100)

## 7. Next Steps for Full Implementation

### 7.1 Install PDF Library
```bash
composer require barryvdh/laravel-dompdf
```

### 7.2 Create Maintenance History Table (if not exists)
```php
// database/migrations/xxxx_create_maintenance_history_table.php
Schema::create('maintenance_history', function (Blueprint $table) {
    $table->id('maintenance_id');
    $table->unsignedInteger('equipment_id');
    $table->date('maintenance_date');
    $table->unsignedInteger('performed_by')->nullable();
    $table->text('findings')->nullable();
    $table->text('action_taken')->nullable();
    $table->enum('status', ['completed', 'pending', 'overdue'])->default('pending');
    $table->date('next_due_date')->nullable();
    $table->dateTime('datetime_added')->nullable();
    
    $table->index('equipment_id');
    $table->index('performed_by');
    $table->index('maintenance_date');
});
```

### 7.3 Add Permissions
```php
php artisan tinker

use Spatie\Permission\Models\Permission;

Permission::create(['name' => 'reports.access']);
Permission::create(['name' => 'reports.export']);

// Assign to Lab Manager role
$role = \Spatie\Permission\Models\Role::findByName('Lab Manager');
$role->givePermissionTo(['reports.access', 'reports.export']);
```

### 7.4 Create PDF View Templates
```php
// resources/views/reports/pdf/calibration.blade.php
<!DOCTYPE html>
<html>
<head>
    <title>Calibration Report</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .header { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Calibration Report</h2>
        <p>Date Range: {{ $dateFrom }} to {{ $dateTo }}</p>
        <p>Generated: {{ $generatedAt->format('M d, Y h:i A') }}</p>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Equipment</th>
                <th>Procedure</th>
                <th>Date</th>
                <th>Result</th>
                <th>Performed By</th>
            </tr>
        </thead>
        <tbody>
            @foreach($data as $record)
                <tr>
                    <td>{{ $record->equipment_name }}</td>
                    <td>{{ $record->procedure_name }}</td>
                    <td>{{ $record->calibration_date }}</td>
                    <td>{{ strtoupper($record->result_status) }}</td>
                    <td>{{ $record->performed_by }}</td>
                </tr>
            @endforeach
        </tbody>
    </table>
</body>
</html>
```

## 8. Best Practices Implemented

✅ **Audit-Friendly**: All reports use LEFT JOINs to preserve deleted records
✅ **Soft Delete Aware**: Queries respect `is_deleted` flags where applicable
✅ **Performance**: Indexed columns used in WHERE/JOIN clauses
✅ **Security**: Permission-based access control on all routes
✅ **Usability**: Responsive filters, search, pagination
✅ **Compliance**: Date ranges, complete audit trails
✅ **Export**: Both PDF (print) and CSV (audit/analysis)

## 9. Testing the Module

1. Navigate to `/reports`
2. Select a report type tab
3. Set date range and filters
4. View results in the table
5. Export to PDF or CSV
6. Verify data accuracy against source tables

## 10. Troubleshooting

**Problem**: "No data found"
- **Solution**: Check date range, ensure test data exists in the date range

**Problem**: "Permission denied"
- **Solution**: Assign `reports.access` permission to your user's role

**Problem**: "Export not working"
- **Solution**: Install dompdf, check file permissions on storage/app

**Problem**: "Table doesn't exist"
- **Solution**: Run migrations, or comment out maintenance report if table not created yet
